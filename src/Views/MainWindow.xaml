<Window x:Class="ContextMenuManager.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:ContextMenuManager.ViewModels"
        xmlns:cvt="clr-namespace:ContextMenuManager.Converters"
        xmlns:props="clr-namespace:ContextMenuManager.Properties"
        Title="{x:Static props:Resources.WindowTitle}"
        Width="820" Height="640"
        MinWidth="700" MinHeight="500"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource BgBrush}"
        FontFamily="Microsoft YaHei UI, Segoe UI">

    <Window.Resources>
        <cvt:BoolToVisibilityConverter x:Key="BoolToVis" />
        <cvt:InverseBoolConverter x:Key="InverseBool" />
        <cvt:RiskLevelToColorConverter x:Key="RiskToColor" />
        <cvt:RiskLevelToBgConverter x:Key="RiskToBg" />
        <cvt:MenuSourceToColorConverter x:Key="SourceToColor" />
        <cvt:MenuSourceToBgConverter x:Key="SourceToBg" />
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />  <!-- Title + menu mode -->
            <RowDefinition Height="Auto" />  <!-- Search -->
            <RowDefinition Height="Auto" />  <!-- Scenario tabs -->
            <RowDefinition Height="*" />     <!-- Menu list -->
            <RowDefinition Height="Auto" />  <!-- Status + actions -->
        </Grid.RowDefinitions>

        <!-- Top: title + language + menu mode -->
        <Border Grid.Row="0" Background="White" Padding="20,16"
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="âš™" FontSize="22" Margin="0,0,10,0" VerticalAlignment="Center" />
                    <StackPanel>
                        <TextBlock Text="{x:Static props:Resources.WindowTitle}"
                                   FontSize="18" FontWeight="SemiBold"
                                   Foreground="{StaticResource TextPrimaryBrush}" />
                        <TextBlock Text="{x:Static props:Resources.Subtitle}"
                                   FontSize="12" Foreground="{StaticResource TextSecondaryBrush}"
                                   Margin="0,2,0,0" />
                    </StackPanel>
                    <ComboBox x:Name="LanguageCombo" MinWidth="100" Margin="20,0,0,0" VerticalAlignment="Center"
                              FontSize="12" ToolTip="{x:Static props:Resources.LanguageRestartHint}"
                              SelectionChanged="LanguageCombo_SelectionChanged" />
                </StackPanel>

                <Border Grid.Column="1" Background="#F5F5F5" CornerRadius="8" Padding="14,8">
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="{x:Static props:Resources.MenuModeLabel}" FontSize="13"
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   VerticalAlignment="Center" Margin="0,0,8,0" />

                        <TextBlock Text="{x:Static props:Resources.Win11New}" FontSize="13"
                                   VerticalAlignment="Center" Margin="0,0,8,0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsClassicMenu}" Value="False">
                                            <Setter Property="Foreground" Value="{StaticResource AccentBrush}" />
                                            <Setter Property="FontWeight" Value="SemiBold" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <CheckBox IsChecked="{Binding IsClassicMenu}"
                                  Style="{StaticResource ToggleSwitchStyle}"
                                  VerticalAlignment="Center"
                                  Command="{Binding ToggleClassicMenuCommand}" />

                        <TextBlock Text="{x:Static props:Resources.Win10Classic}" FontSize="13"
                                   VerticalAlignment="Center" Margin="8,0,0,0">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsClassicMenu}" Value="True">
                                            <Setter Property="Foreground" Value="{StaticResource AccentBrush}" />
                                            <Setter Property="FontWeight" Value="SemiBold" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <Border Grid.Row="1" Padding="20,12,20,0">
            <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                     Tag="{x:Static props:Resources.SearchPlaceholder}"
                     Style="{StaticResource SearchBoxStyle}" />
        </Border>

        <Border Grid.Row="2" Padding="20,8,20,0">
            <Border Background="White" CornerRadius="6,6,0,0"
                    BorderBrush="{StaticResource BorderBrush}" BorderThickness="1,1,1,0">
                <StackPanel Orientation="Horizontal">
                    <RadioButton Content="{x:Static props:Resources.Scenario_File}" IsChecked="True"
                                 Style="{StaticResource ScenarioTabStyle}"
                                 Command="{Binding SelectScenarioCommand}"
                                 CommandParameter="File" />
                    <RadioButton Content="{x:Static props:Resources.Scenario_Directory}"
                                 Style="{StaticResource ScenarioTabStyle}"
                                 Command="{Binding SelectScenarioCommand}"
                                 CommandParameter="Directory" />
                    <RadioButton Content="{x:Static props:Resources.Scenario_DirectoryBackground}"
                                 Style="{StaticResource ScenarioTabStyle}"
                                 Command="{Binding SelectScenarioCommand}"
                                 CommandParameter="DirectoryBackground" />
                    <RadioButton Content="{x:Static props:Resources.Scenario_DesktopBackground}"
                                 Style="{StaticResource ScenarioTabStyle}"
                                 Command="{Binding SelectScenarioCommand}"
                                 CommandParameter="DesktopBackground" />

                    <TextBlock VerticalAlignment="Center" Margin="16,0,0,0"
                               FontSize="12" Foreground="{StaticResource TextSecondaryBrush}">
                        <Run Text="{Binding FilteredItemCount, Mode=OneWay}" />
                        <Run Text="{x:Static props:Resources.ItemsCountSuffix}" />
                    </TextBlock>
                </StackPanel>
            </Border>
        </Border>

        <Border Grid.Row="3" Margin="20,0,20,0"
                Background="White"
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="1"
                CornerRadius="0,0,6,6">
            <Grid>
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0">
                    <ItemsControl ItemsSource="{Binding FilteredItems}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="16,12" BorderBrush="#F0F0F0" BorderThickness="0,0,0,1"
                                        Background="Transparent" Cursor="Hand">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background">
                                                        <Setter.Value>
                                                            <SolidColorBrush Color="#FAFAFA" />
                                                        </Setter.Value>
                                                    </Setter>
                                                </Trigger>
                                                <DataTrigger Binding="{Binding HasChanges}" Value="True">
                                                    <Setter Property="Background">
                                                        <Setter.Value>
                                                            <SolidColorBrush Color="#FFF8E1" />
                                                        </Setter.Value>
                                                    </Setter>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="56" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <CheckBox Grid.Column="0"
                                                  IsChecked="{Binding IsEnabled}"
                                                  Style="{StaticResource ToggleSwitchStyle}"
                                                  VerticalAlignment="Center" />

                                        <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="4,0,12,0">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding DisplayName}"
                                                           FontSize="14" FontWeight="Medium"
                                                           Foreground="{StaticResource TextPrimaryBrush}" />
                                                <TextBlock Text="{Binding ItemTypeDisplayName}"
                                                           FontSize="10" Foreground="{StaticResource TextSecondaryBrush}"
                                                           VerticalAlignment="Center"
                                                           Margin="8,1,0,0"
                                                           Opacity="0.6" />
                                            </StackPanel>
                                            <TextBlock FontSize="12" Margin="0,3,0,0"
                                                       Foreground="{StaticResource TextSecondaryBrush}"
                                                       TextWrapping="Wrap">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Text" Value="{Binding Description}" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Description}" Value="">
                                                                <Setter Property="Text" Value="{Binding RegistryPath}" />
                                                                <Setter Property="Opacity" Value="0.5" />
                                                                <Setter Property="FontSize" Value="11" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                        </StackPanel>

                                        <StackPanel Grid.Column="2" Orientation="Horizontal"
                                                    VerticalAlignment="Center" HorizontalAlignment="Right">
                                            <Border CornerRadius="3" Padding="8,3" Margin="0,0,6,0"
                                                    Background="{Binding Source, Converter={StaticResource SourceToBg}}">
                                                <TextBlock Text="{Binding SourceDisplayName}" FontSize="11"
                                                           Foreground="{Binding Source, Converter={StaticResource SourceToColor}}" />
                                            </Border>

                                            <Border CornerRadius="3" Padding="8,3" Margin="0,0,6,0"
                                                    Background="{Binding Risk, Converter={StaticResource RiskToBg}}">
                                                <TextBlock Text="{Binding RiskDisplayName}" FontSize="11"
                                                           Foreground="{Binding Risk, Converter={StaticResource RiskToColor}}" />
                                            </Border>

                                            <TextBlock Text="{Binding RegistryScopeDisplayName}" FontSize="11"
                                                       Foreground="{StaticResource TextSecondaryBrush}"
                                                       VerticalAlignment="Center" Margin="0,0,6,0" Opacity="0.8" />

                                            <TextBlock Text=" â—" FontSize="14" Foreground="#FF8C00"
                                                       VerticalAlignment="Center" Margin="6,0,0,0"
                                                       Visibility="{Binding HasChanges, Converter={StaticResource BoolToVis}}"
                                                       ToolTip="{x:Static props:Resources.TooltipHasChanges}" />
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <Border Background="#CCFFFFFF"
                        Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                        <TextBlock Text="{x:Static props:Resources.Loading}" FontSize="16"
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   HorizontalAlignment="Center" />
                    </StackPanel>
                </Border>

                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                            Margin="0,40,0,0">
                    <StackPanel.Style>
                        <Style TargetType="StackPanel">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding FilteredItemCount}" Value="0" />
                                        <Condition Binding="{Binding IsLoading}" Value="False" />
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Visible" />
                                </MultiDataTrigger>
                            </Style.Triggers>
                        </Style>
                    </StackPanel.Style>
                    <TextBlock Text="ðŸ”" FontSize="36" HorizontalAlignment="Center" Margin="0,0,0,8" />
                    <TextBlock Text="{x:Static props:Resources.NoItemsFound}" FontSize="15"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               HorizontalAlignment="Center" />
                    <TextBlock Text="{x:Static props:Resources.NoItemsHint}" FontSize="12"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               HorizontalAlignment="Center" Margin="0,4,0,0" Opacity="0.7" />
                </StackPanel>
            </Grid>
        </Border>

        <Border Grid.Row="4" Background="White" Padding="20,12"
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="{Binding StatusMessage}" FontSize="12"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               VerticalAlignment="Center"
                               MaxWidth="350" TextTrimming="CharacterEllipsis" />
                </StackPanel>

                <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal">
                    <Button Content="{x:Static props:Resources.ButtonRefresh}" Command="{Binding RefreshCommand}"
                            Style="{StaticResource SecondaryButtonStyle}" Margin="0,0,6,0" />

                    <Button Content="{x:Static props:Resources.ButtonSync}"
                            Style="{StaticResource SecondaryButtonStyle}"
                            Margin="0,0,6,0"
                            Click="SyncSettingsButton_Click" />

                    <Button x:Name="BackupMenuButton" Style="{StaticResource SecondaryButtonStyle}"
                            Margin="0,0,6,0" Click="BackupMenuButton_Click">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{x:Static props:Resources.ButtonBackup}" />
                        </StackPanel>
                    </Button>
                    <Popup x:Name="BackupPopup" PlacementTarget="{Binding ElementName=BackupMenuButton}"
                           Placement="Top" StaysOpen="False" AllowsTransparency="True">
                        <Border Background="White" BorderBrush="{StaticResource BorderBrush}"
                                BorderThickness="1" CornerRadius="6" Padding="4"
                                Margin="0,0,0,4">
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="12" ShadowDepth="2" Opacity="0.15" />
                            </Border.Effect>
                            <StackPanel MinWidth="200">
                                <Button Content="{x:Static props:Resources.RestoreLastBackup}" Command="{Binding RestoreLastBackupCommand}"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        HorizontalContentAlignment="Left"
                                        BorderThickness="0" Margin="0,0,0,2" />
                                <Button Content="{x:Static props:Resources.RestoreDefault}" Command="{Binding RestoreDefaultCommand}"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        HorizontalContentAlignment="Left"
                                        BorderThickness="0" Margin="0,0,0,2" />
                                <Separator Margin="4,2" />
                                <Button Content="{x:Static props:Resources.OpenBackupFolder}" Command="{Binding OpenBackupFolderCommand}"
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        HorizontalContentAlignment="Left"
                                        BorderThickness="0" />
                            </StackPanel>
                        </Border>
                    </Popup>

                    <Button Content="{x:Static props:Resources.RestartExplorer}" Command="{Binding RestartExplorerCommand}"
                            Style="{StaticResource SecondaryButtonStyle}" Margin="0,0,6,0"
                            ToolTip="{x:Static props:Resources.TooltipRestartExplorer}" />

                    <Button Command="{Binding ApplyChangesCommand}"
                            Style="{StaticResource PrimaryButtonStyle}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{x:Static props:Resources.ApplyChanges}" />
                            <TextBlock Text=" â—" Foreground="#FFD700" FontWeight="Bold"
                                       Visibility="{Binding HasUnappliedChanges, Converter={StaticResource BoolToVis}}" />
                        </StackPanel>
                    </Button>
                </StackPanel>

                <TextBlock Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                           Text="{x:Static props:Resources.HintRestartExplorer}"
                           FontSize="11" Foreground="{StaticResource TextSecondaryBrush}"
                           Opacity="0.85" Margin="0,8,0,0" />
            </Grid>
        </Border>
    </Grid>
</Window>
